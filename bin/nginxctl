#!/bin/sh

die() { echo "$@"; exit 1; }

list_enabled_sites()   { ls -1 "/etc/nginx/sites-enabled/";   }
list_available_sites() { ls -1 "/etc/nginx/sites-available/"; }

enable_site() {
	readonly SITE="${1}"

	test -f "/etc/nginx/sites-available/${SITE}" || die "unknown site: ${SITE}"

	set -eux
	ln -f -s "/etc/nginx/sites-available/${SITE}" "/etc/nginx/sites-enabled/${SITE}"
	nginx -t
	systemctl reload nginx
}

disable_site() {
	readonly SITE="${1}"

	test -f "/etc/nginx/sites-available/${SITE}" || die "unknown site: ${SITE}"

	set -eux
	rm -f "/etc/nginx/sites-enabled/${SITE}"
	nginx -t
	systemctl reload nginx
}


test "${1}" || die "usage: nginxctl <command> <args>"
readonly COMMAND="${1}"; shift

case "${COMMAND}" in
	list-available-sites|list-enabled-sites)
		$(echo ${COMMAND} | tr - _) $@
		;;
	enable-site|disable-site)
		test "${1}" || die "usage: nginxctl ${COMMAND} <site>"
		test $(id -u) -eq 0 || die "must be root"
		$(echo ${COMMAND} | tr - _) $@
		;;
	list-users)
		test "${1}" || die "usage: nginxctl ${COMMAND} <site>"
		test $(id -u) -eq 0 || die "must be root"
		$(echo ${COMMAND} | tr - _) $@
		;;
	list-users|add-user|remove-user|change-user-password|change-user-name)
		die "not currently implemented: ${COMMAND}"
		;;
	*)
		die "unknown command: ${COMMAND}"
		;;
esac
